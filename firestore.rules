rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow anyone to read user profiles for the directory.
    // Allow authenticated users to write to their own document.
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow authenticated users to create tasks.
    // Allow anyone to read tasks.
    // Allow the task poster to update and delete their own tasks.
    // Allow any authenticated user to update the interestedCount or assign the task to themselves.
    match /tasks/{taskId} {
      allow create: if request.auth != null;
      allow read: if true;
      
      // Client can update/delete their own task.
      // A freelancer can update it ONLY to accept it.
      allow update: if request.auth != null && 
                    (request.auth.uid == resource.data.clientId || 
                     (request.resource.data.status == 'assigned' && request.resource.data.assignedTo == request.auth.uid));

      allow delete: if request.auth != null && request.auth.uid == resource.data.clientId;
    }

    // Allow authenticated users to show interest in a task,
    // as long as they are the freelancer creating the interest document.
    match /intrested/{interestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.freelancerId == request.auth.uid;
    }
  }
}
